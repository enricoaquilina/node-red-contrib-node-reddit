<!-- START Config Node -->
<script type="text/x-red" data-template-name="reddit-credentials">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span> Name</span></label>
        <input type="text" id="node-config-input-name">
    </div>
    <hr>
    <div class="form-row">
        <label for="node-config-input-client_id"><i class="fa fa-tag"></i> <span>Client ID</span></label>
        <input type="text" id="node-config-input-client_id">
    </div>
    <div class="form-row">
        <label for="node-config-input-client_secret"><i class="fa fa-key"></i> <span> Client secret</span></label>
        <input type="text" id="node-config-input-client_secret">
    </div>
    <div class="form-row">
        <label for="node-config-input-user_agent"><i class="fa fa-tag"></i> <span> User agent</span></label>
        <input type="text" id="node-config-input-user_agent">
    </div>
    <div class="form-row" id="node-action-auth_type"> 
        <label for="node-config-input-auth_type"><i class="fa fa-wrench"></i> Authentication</label>
        <select type="text" id="node-config-input-auth_type" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="username_password" outputs="1">Username/password</option>
            <option value="refresh_token" outputs="1">Refresh token</option>
            <option value="access_token" outputs="1">Access token</option>
        </select>
    </div>
    <div class="form-row" id="node-action-username">
        <label for="node-config-input-username"><i class="fa fa-tag"></i> <span> Username</span></label>
            <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row" id="node-action-password">
        <label for="node-config-input-password"><i class="fa fa-key"></i> <span> Password</span></label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row" id="node-action-refresh_token">
        <label for="node-config-input-refresh_token"><i class="fa fa-key"></i> <span> Refresh Token</span></label>
        <input type="text" id="node-config-input-refresh_token">
    </div>
    <div class="form-row" id="node-action-access_token">
        <label for="node-config-input-access_token"><i class="fa fa-key"></i> <span> Access Token</span></label>
        <input type="text" id="node-config-input-access_token">
    </div>
</script>

<script type="text/javascript">
    function oneditprepare() {
        function hideExtraActions(){
            $("#node-action-username").hide();
            $("#node-action-password").hide();
            $("#node-action-refresh_token").hide();
            $("#node-action-access_token").hide();
        }

        function showActions(){
            var auth_type = $("#node-config-input-auth_type option:selected").val();
            if (auth_type == "username_password") {
                $("#node-action-username").show();
                $("#node-action-password").show();
            }
            else if (auth_type == "refresh_token"){
                $("#node-action-refresh_token").show();
            } 
            else if (auth_type == "access_token"){
                $("#node-action-access_token").show();
            } 
        }

        $("#node-config-input-auth_type").change(function() {
            hideExtraActions()
            showActions()
        });

        hideExtraActions()
        showActions()
    }


    RED.nodes.registerType('reddit-credentials',{
      defaults: {
        username: {value:"", required: false},
        user_agent: {value:"", required: true},
        auth_type:  {value:"username_password", required: false},
        name: {value:"", required: false}
        },
      category: 'config',
      credentials: {
        password: {type: "password", required: false},
        client_id: {type: "password", required: true},
        client_secret: {type: "password", required: true},
        refresh_token: {type:"password", required: false},
        access_token: {type:"password", required: false}
      },
      label: function() {
        return this.username || this.name;
      },
      exportable: false,
      icon: "snoo2.png",
      color:"#ffa27f",
      oneditprepare: oneditprepare
    });
</script>

<script type="text/x-red" data-help-name="reddit-credentials">
    <p>Authentication for the Reddit API</p>
    <p>To create a Reddit app and obtain its Client ID and Client Secret, log in to your Reddit account and visit <a href="https://ssl.reddit.com/prefs/apps/">this link.</a></p>
    <p>There are 3 ways to provide authentication:</p>
    <ol>
        <li><i>Username/password</i>: For long-term access. Possible for script-type apps only.</li>
        <li><i>Refresh token</i>: For long-term access. Visit <a href="https://not-an-aardvark.github.io/reddit-oauth-helper/">here</a> to generate a token.</li>
        <li><i>Access token</i>: For short-term access. Expires in one hour. Visit <a href="https://not-an-aardvark.github.io/reddit-oauth-helper/">here</a> to generate a token.</li>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/reddit-archive/reddit/wiki/oauth2">Reddit OAuth2 docs</a> - full description of authtication methods</li>
        <li><a href="https://not-an-aardvark.github.io/snoowrap/snoowrap.html">Snoowrap docs</a> - guidelines for creating Snoowrap objects</li>
    </ul>
</script>
<!-- END Config Node -->

<!-- START Create -->
<script type="text/javascript">
  RED.nodes.registerType('create', {
    category: 'reddit',
    color: '#a6bbcf',
    defaults: {
      name: {value: ""},
      reddit: { type: "reddit-credentials", required: true},
      submissionType: {value: "self"},
      subreddit: {value: ""},
      title: {value: ""},
      url: {value: ""},
      text: {value: ""},
      original: {value: ""},
      recipient: {value: ""},
      subject: {value: ""},
      message: {value: ""},
    },
    inputs:1,
    outputs:1,
    icon: "snoo2.png",
    color:"#ffa27f",
    label: function() {
      if (this.name) {
        return this.name;
      } else if (this.subreddit && this.subreddit.indexOf("{{") == -1) {
        return "r/" + this.subreddit;
      } else if (this.recipient && this.recipient.indexOf("{{") == -1) {
        return "u/" + this.recipient;
      } else {
        return "create";
      }
    },
    oneditprepare: () => {
      $("#node-input-submissionType").change(() => {
        $("#node-action-subreddit").hide();
        $("#node-action-title").hide();
        $("#node-action-text").hide();
        $("#node-action-url").hide();
        $("#node-action-original").hide();
        $("#node-action-subject").hide();
        $("#node-action-recipient").hide();
        $("#node-action-message").hide();
  
        let type = $("#node-input-submissionType option:selected").val();

        if (type === "self") {
          $("#node-action-subreddit").show();
          $("#node-action-title").show();
          $("#node-action-text").show();
        } else if (type === "link") {
          $("#node-action-subreddit").show();
          $("#node-action-title").show();
          $("#node-action-url").show();
        } else if (type === "cross") {
          $("#node-action-subreddit").show();
          $("#node-action-title").show();
          $("#node-action-original").show();
        } else if (type === "pm") {
          $("#node-action-recipient").show();
          $("#node-action-subject").show();
          $("#node-action-message").show();
        }
      });
    },
  });
</script>
  
<script type="text/x-red" data-template-name="create">
  <div class="form-row">
    <label for="node-input-reddit"><i class="fa fa-key"></i>Credentials</label>
    <input type="text" id="node-input-reddit">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i>Name</label>
    <input type="text" id="node-input-name" placeholder="optional name for this node">
  </div>
  <hr>
  <div class="form-row"> 
    <label for="node-input-submissionType"><i class="fa fa-wrench"></i>Type</label>
    <select type="text" id="node-input-submissionType" style="display: inline-block; width: 250px; vertical-align: top;">
      <option value="self" outputs="1">self-post</option>
      <option value="link" outputs="1">link post</option>
      <option value="cross" outputs="1">cross-post</option>
      <option value="pm" outputs="1">private message</option>
    </select>
  </div>
  <div class="form-row" id="node-action-subreddit">
    <label for="node-input-subreddit"><i class="icon-tag"></i>Subreddit</label>
    <input type="text" id="node-input-subreddit" placeholder="subreddit name">
  </div>
  <div class="form-row" id="node-action-title">
    <label for="node-input-title"><i class="icon-tag"></i>Title</label>
    <input type="text" id="node-input-title" placeholder="post title">
  </div>
  <div class="form-row" id="node-action-text">
    <label for="node-input-text"><i class="icon-tag"></i>Text</label>
    <input type="text" id="node-input-text" placeholder="content">
  </div>
  <div class="form-row" id="node-action-url">
    <label for="node-input-url"><i class="icon-tag"></i>URL</label>
    <input type="text" id="node-input-url" placeholder="url to link">
  </div>
  <div class="form-row" id="node-action-original">
    <label for="node-input-original"><i class="icon-tag"></i>Original</label>
    <input type="text" id="node-input-original" placeholder="original submission id">
  </div>
  <div class="form-row" id="node-action-recipient">
    <label for="node-input-recipient"><i class="icon-tag"></i>To</label>
    <input type="text" id="node-input-recipient" placeholder="recipient's username">
  </div>
  <div class="form-row" id="node-action-subject">
    <label for="node-input-subject"><i class="icon-tag"></i>Subject</label>
    <input type="text" id="node-input-subject" placeholder="message subject">
  </div>
  <div class="form-row" id="node-action-message">
    <label for="node-input-message"><i class="icon-tag"></i>Message</label>
    <input type="text" id="node-input-message" placeholder="message">
  </div>
</script>

<script type="text/x-red" data-help-name="create">
  <p>Create a new Reddit submission or PM.</p>

  <h3>Inputs</h3>
    <dl class="message-properties">
      <dt>credentials <span class="property-type">config node</span></dt>
      <dd> your reddit credentials.</dd>
      <dt class="optional">name <span class="property-type">string</span></dt>
      <dd> the name of this node.</dd>
      <dt>type <span class="property-type">selection</span></dt>
      <dd> choose self-, link-,  or cross-post, or PM.</dd>
      <hr>
      &nbsp;<b>For Submissions:</b>
      <dt>subreddit <span class="property-type">string</span></dt>
      <dd> the subreddit to submit to.</dd>
      <dt>title <span class="property-type">string</span></dt>
      <dd> the title of the submission.</dd>
      <dt>  - text <span class="property-type">string</span></dt>
      <dd>     the text of a self-post.</dd>
      <dt>  - url <span class="property-type">string</span></dt>
      <dd>     the url of a link-post.</dd>
      <dt>  - original <span class="property-type">string</span></dt>
      <dd>     the original listing name for a cross-post.</dd>
      <hr>
      &nbsp;<b>For PMs:</b>
      <dt>recipient <span class="property-type">string</span></dt>
      <dd> the recipient of the PM.</dd>
      <dt>subject <span class="property-type">string</span></dt>
      <dd> the subject of the PM.</dd>
      <dt>message <span class="property-type">string</span></dt>
      <dd> the mesage of a PM.</dd>
    </dl>

  <h3>Outputs</h3>
    <ol class="node-ports">
      <li>Standard output
        <dl class="message-properties">
          <dt>payload <span class="property-type">object</span></dt>
          <dd> the name of the new submission listing.</dd>
        </dl>
      </li>
      <li>Standard error
        <dl class="message-properties">
          <dt>payload <span class="property-type">string</span></dt>
          <dd>the standard error of the command.</dd>
         </dl>
      </li>
    </ol>

  <h3>Details</h3>
    <p>Exclude the "r/" when entering your <code>subreddit</code>. "r/<code>subreddit</code>" will be 
    used for the display name if <code>name</code> is left empty.
    </p>
    <p>Exclude the "u/" when entering your <code>recipient</code>. "u/<code>recipient</code>" will be
    used for the display name if <code>name</code> is left empty.
    </p>
    <p>
    Properties can also be set using mustache syntax of the <code>msg.payload</code>. 
    </p>

  <h3>References</h3>
    <ul>
      <li><a href='https://www.reddit.com/dev/api/'>Reddit API docs</a> - descriptions of the 3 submission types</li>
      <li><a href='https://github.com/jcostello93/Node-Red'>Node-Reddit on GitHub</a> - the Node-Reddit github repository</li>
    </ul>
</script>
<!-- END Create  -->
