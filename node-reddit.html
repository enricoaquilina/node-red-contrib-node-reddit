<!-- START Config Node -->
<script type="text/x-red" data-template-name="reddit-credentials">
    <div class="form-row">
      <label for="node-config-input-username"><i class="fa fa-tag"></i> <span>username</span></label>
      <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row">
      <label for="node-config-input-password"><i class="fa fa-key"></i> <span>password</span></label>
      <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row">
        <label for="node-config-input-client_id"><i class="fa fa-tag"></i> <span>client_id</span></label>
        <input type="text" id="node-config-input-client_id">
    </div>
    <div class="form-row">
        <label for="node-config-input-client_secret"><i class="fa fa-key"></i> <span>client_secret</span></label>
        <input type="text" id="node-config-input-client_secret">
    </div>
    <div class="form-row">
        <label for="node-config-input-user_agent"><i class="fa fa-tag"></i> <span>user_agent</span></label>
        <input type="text" id="node-config-input-user_agent">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('reddit-credentials',{
      defaults: {
        username: {value:"", required: true},
        user_agent: {value:"", required: true}
        },
      category: 'config',
      credentials: {
        password: {type: "password", required: true},
        client_id: {type: "password", required: true},
        client_secret: {type: "password", required: true}
      },
      label: function() {
        return this.username;
      },
      exportable: false
    });
</script>
<!-- END Config Node -->


<!-- START Get content -->
<script type="text/javascript">
    function oneditprepare() {
        function resetFetchAll() {
            // A user can get his own submissions/comments using fetch_all 
            if ($("#node-input-user").val() == $("#node-input-reddit option:selected").text() && $("#node-input-source option:selected").val() == "user") {
                return
            }
            
            // A user can get his PMs using fetch_all
            if ($("#node-input-content_type option:selected").val() == "pm") {
                return 
            }

            // In every other case, fetch_all is set to false
            $("#node-input-fetch_all").val("false");
        }


        function hideExtraActions(){
            $("#node-action-source").hide();
            $("#node-action-subreddit").hide();
            $("#node-action-user").hide();
            $("#node-action-sort").hide();
            $("#node-action-time").hide();
            $("#node-action-limit").hide();
            $("#node-action-fetch_all").hide();
        }

        function showActions() { 
            // 1. type
            // 2. source
            // 3. subreddit
            // 4. user
            // 5. sort
            // 6. time
            // 7. fetch all
            // 8. limit

            // Submission, source


            var source = $("#node-input-source option:selected").val();
            var type = $("#node-input-content_type option:selected").val();
            var sort = $("#node-input-sort option:selected").val();
            
            if (type == "submission") {
                if (source == "subreddit") {
                    $("#node-action-subreddit").show();
                    if (sort == "top" || sort == "controversial") {
                        $("#node-action-time").show();
                    }
                }
                else if (source == "user") {
                    $("#node-action-user").show();
                }
                $("#node-action-sort").show();
                $("#node-action-source").show()

            }
            else if (type == "comment") {
                if (source == "subreddit") {
                    $("#node-action-subreddit").show();
                }
                else if (source == "user") {
                    $("#node-action-user").show();
                }
                $("#node-action-source").show()
            }
            else if (type == "pm") {
                $("#node-action-fetch_all").show();
            }

            if (source == "user" && $("#node-input-user").val() == $("#node-input-reddit option:selected").text()) {
                $("#node-action-fetch_all").show();
            }

            if ($("#node-input-fetch_all").val() != "true") {
                $("#node-action-limit").show();
            }
        }
        
        $("#node-input-reddit").change(function() {
            resetFetchAll()
            hideExtraActions()
            showActions()
        });

        $("#node-input-content_type").change(function() {
            resetFetchAll()
            hideExtraActions()
            showActions()
        });

        $("#node-input-source").change(function() {
            resetFetchAll()
            hideExtraActions()
            showActions()
        });

        $("#node-input-user").keyup(function() {
            resetFetchAll()
            hideExtraActions()
            showActions()
        });

        $("#node-input-fetch_all").change(function() {            
            hideExtraActions()
            showActions()
        });

        $("#node-input-sort").change(function() {   
            hideExtraActions()
            showActions()
        });
    }
    

    RED.nodes.registerType('get content',{
        category: 'reddit',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            reddit: { type:"reddit-credentials",required:true},
            content_type: {value:"submission"},
            source: {value:"subreddit"},
            subreddit: {value:""},
            user: {value:""},
            limit: {value:""},
            sort: {value:"hot"},
            time: {value:"hour"},
            fetch_all: {value:"false"}
        },
        inputs:1,
        outputs:1,
        icon: "file.png",
        label: function() {
            return this.name||"get content";
        },
        oneditprepare: oneditprepare
    });
</script>

<script type="text/x-red" data-template-name="get content">
    <div class="form-row">
        <label for="node-input-reddit"><i class="fa fa-key"></i> <span>Credentials</span></label>
        <input type="text" id="node-input-reddit">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-content_type"><i class="fa fa-wrench"></i> Type</label>
        <select type="text" id="node-input-content_type" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="submission" outputs="1">Submission</option>
            <option value="comment" outputs="1">Comment</option>
            <option value="pm" outputs="1">PM</option>
        </select>
    </div>
    <div class="form-row" id="node-action-source">
        <label for="node-input-source"><i class="fa fa-wrench"></i> Source</label>
        <select type="text" id="node-input-source" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="subreddit" outputs="1">Subreddit</option>
            <option value="user" outputs="1">User</option>
        </select>
    </div>
    <div class="form-row" id="node-action-subreddit">
        <label for="node-input-subreddit"><i class="icon-tag"></i> Subreddit</label>
        <input type="text" id="node-input-subreddit" placeholder="subreddit">
    </div>
    <div class="form-row" id="node-action-user">
        <label for="node-input-user"><i class="icon-tag"></i> User</label>
        <input type="text" id="node-input-user" placeholder="user">
    </div>
    <div class="form-row" id="node-action-sort"> 
        <label for="node-input-sort"><i class="fa fa-wrench"></i> Sort by</label>
        <select type="text" id="node-input-sort" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="hot" outputs="1">Hot</option>
            <option value="new" outputs="1">New</option>
            <option value="rising" outputs="1">Rising</option>
            <option value="controversial" outputs="1">Controversial</option>
            <option value="top" outputs="1">Top</option>
        </select>
    </div>
    <div class="form-row" id="node-action-time"> 
        <label for="node-input-time"><i class="fa fa-wrench"></i> Time</label>
        <select type="text" id="node-input-time" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="hour" outputs="1">Hour</option>
            <option value="day" outputs="1">Day</option>
            <option value="week" outputs="1">Week</option>
            <option value="month" outputs="1">Month</option>
            <option value="year" outputs="1">Year</option>
            <option value="all" outputs="1">All time</option>
        </select>
    </div>
    <div class="form-row" id="node-action-fetch_all">
        <label for="node-input-fetch_all"><i class="icon-tag"></i> Fetch All</label>
        <select type="text" id="node-input-fetch_all" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="true" outputs="1">True</option>
            <option value="false" outputs="1">False</option>
        </select>
    </div>
    <div class="form-row" id="node-action-limit">
        <label for="node-input-limit"><i class="icon-tag"></i> Limit</label>
        <input type="number" id="node-input-limit" placeholder="limit">
    </div>    
</script>

<script type="text/x-red" data-help-name="get content">
    <p>Get Reddit content</p>
</script>

<!-- END Get content -->




<!-- START Reply -->
<script type="text/javascript">
    RED.nodes.registerType('reply',{
        category: 'reddit',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            reddit: { type:"reddit-credentials",required:true},
            content_type: {value:"submission"},
            content_id: {value:""},
            text: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "file.png",
        label: function() {
            return this.name||"reply";
        }
    });
</script>

<script type="text/x-red" data-template-name="reply">
    <div class="form-row">
        <label for="node-input-reddit"><i class="fa fa-key"></i> <span>Credentials</span></label>
        <input type="text" id="node-input-reddit">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-content_type"><i class="fa fa-wrench"></i> Type</label>
        <select type="text" id="node-input-content_type" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="submission" outputs="1">Submission</option>
            <option value="comment" outputs="1">Comment</option>
            <option value="pm" outputs="1">PM</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-content_id"><i class="icon-tag"></i> Content_id</label>
        <input type="text" id="node-input-content_id" placeholder="Content_id">
    </div>
    <div class="form-row">
        <label for="node-input-text"><i class="icon-tag"></i> Text</label>
        <input type="text" id="node-input-text" placeholder="Text">
    </div>
</script>

<script type="text/x-red" data-help-name="reply">
    <p>Reply</p>
</script>
<!-- END Reply -->


<!-- START Search -->
<script type="text/javascript">
    RED.nodes.registerType('search',{
        category: 'reddit',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            reddit: { type:"reddit-credentials",required:true},
            subreddit: {value:"", required:true},
            query: {value:"", required:true},
            time: {value:"hour"},
            sort: {value:"relevance"},
        },
        inputs:1,
        outputs:1,
        icon: "file.png",
        label: function() {
            return this.name||"search";
        }
    });
</script>

<script type="text/x-red" data-template-name="search">
    <div class="form-row">
        <label for="node-input-reddit"><i class="fa fa-key"></i> <span>Credentials</span></label>
        <input type="text" id="node-input-reddit">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-subreddit"><i class="icon-tag"></i> Subreddit</label>
        <input type="text" id="node-input-subreddit" placeholder="Subreddit">
    </div>
    <div class="form-row">
        <label for="node-input-query"><i class="icon-tag"></i> Query</label>
        <input type="text" id="node-input-query" placeholder="Query">
    </div>
    <div class="form-row" id="node-action-time"> 
        <label for="node-input-time"><i class="fa fa-wrench"></i> Time</label>
        <select type="text" id="node-input-time" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="hour" outputs="1">Hour</option>
            <option value="day" outputs="1">Day</option>
            <option value="week" outputs="1">Week</option>
            <option value="month" outputs="1">Month</option>
            <option value="year" outputs="1">Year</option>
            <option value="all" outputs="1">All time</option>
        </select>
    </div>
    <div class="form-row" id="node-action-sort"> 
        <label for="node-input-sort"><i class="fa fa-wrench"></i> Sort by</label>
        <select type="text" id="node-input-sort" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="relevance" outputs="1">Relevance</option>
            <option value="hot" outputs="1">Hot</option>
            <option value="new" outputs="1">New</option>
            <option value="comments" outputs="1">Comments</option>
            <option value="top" outputs="1">Top</option>
        </select>
    </div>
</script>

<script type="text/x-red" data-help-name="search">
    <p>Search subreddit</p>
</script>
<!-- END Search -->

<!-- START Create Submission -->
<script type="text/javascript">
  RED.nodes.registerType('create-submission', {
    category: 'reddit',
    color: '#a6bbcf',
    defaults: {
      name: {value: ""},
      reddit: { type: "reddit-credentials", required: true},
      submissionType: {value: "link"},
      subreddit: {value: "", required: true},
      title: {value: "", required: true},
      url: {value: ""},
      text: {value: ""},
      original: {value: ""},
    },
    inputs:1,
    outputs:1,
    icon: "file.png",
    label: function() {
      if (this.name) {
        return this.name;
      } else if (this.subreddit && this.subreddit.indexOf("{{") == -1) {
        return this.subreddit;
      } else {
        return "create-submission";
      }
    },
    oneditprepare: () => {
      $("#node-input-submissionType").change(() => {
        $("#node-action-text").hide();
        $("#node-action-url").hide();
        $("#node-action-original").hide();

        let type = $("#node-input-submissionType option:selected").val();
      
        if (type === "self") {
          $("#node-action-text").show();
        } else if (type === "link") {
          $("#node-action-url").show();
        } else if (type === "cross") {
          $("#node-action-original").show();
        }
      });
    }
  });
</script>

<script type="text/x-red" data-template-name="create-submission">
  <div class="form-row">
    <label for="node-input-reddit"><i class="fa fa-key"></i>Credentials</label>
    <input type="text" id="node-input-reddit">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i>Name</label>
    <input type="text" id="node-input-name" placeholder="optional name for this node">
  </div>
  <hr>
  <div class="form-row"> 
    <label for="node-input-submissionType"><i class="fa fa-wrench"></i>Type</label>
    <select type="text" id="node-input-submissionType" style="display: inline-block; width: 250px; vertical-align: top;">
      <option value="self" outputs="1">self-post</option>                            
      <option value="link" outputs="1">link post</option>                            
      <option value="cross" outputs="1">cross-post</option>                          
    </select>
  </div>
  <div class="form-row">
    <label for="node-input-subreddit"><i class="icon-tag"></i>Subreddit</label>
    <input type="text" id="node-input-subreddit" placeholder="subreddit name">
  </div>
  <div class="form-row">
    <label for="node-input-title"><i class="icon-tag"></i>Title</label>
    <input type="text" id="node-input-title" placeholder="post title">
  </div>
  <div class="form-row" id="node-action-url">
    <label for="node-input-url"><i class="icon-tag"></i>URL</label>
    <input type="text" id="node-input-url" placeholder="url to link">
  </div>
  <div class="form-row" id="node-action-original">
    <label for="node-input-original"><i class="icon-tag"></i>Original</label>
    <input type="text" id="node-input-original" placeholder="original submission id">
  </div>
  <div class="form-row" id="node-action-text">
    <label for="node-input-text"><i class="icon-tag"></i>Text</label>
    <input type="text" id="node-input-text" placeholder="optional content">
  </div>
</script>

<script type="text/x-red" data-help-name="create-submission">
  <p>Create a submission</p>
</script>
<!-- END Create Submission -->

<!-- START Stream -->
<script type="text/javascript">
  RED.nodes.registerType('stream', {
    category: 'reddit',
    color: '#a6bbcf',
    defaults: {
      name: {value: ""},
      reddit: {type: "reddit-credentials", required: true},
      kind: {value: "submissions", required: true},
      subreddit: {value: "", required: true},
      timeout: {value: ""}
    },
    inputs: 0,
    outputs: 1,
    icon: "inject.png",
    label: function() {
      if (this.name) {
        return this.name;
      } else if (this.subreddit) {
        return "r/" + this.subreddit;
      } else {
        return "stream";
      }
    }
  });
</script>

<script type="text/x-red" data-template-name="stream">
  <div class="form-row">
    <label for="node-input-reddit"><i class="fa fa-key"></i> Credentials</label>
    <input type="text" id="node-input-reddit">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="optional name for this node">
  </div>
  <hr>
  <div class="form-row"> 
    <label for="node-input-kind"><i class="fa fa-wrench"></i> Stream</label>
    <select type="text" id="node-input-kind" style="display: inline-block; width: 250px; vertical-align: top;">
      <option value="submissions" outputs="1">Submissions</option>                            
      <option value="comments" outputs="1">Comments</option>                            
    </select>
  </div>
  <div class="form-row">
    <label for="node-input-subreddit"><i class="icon-tag"></i> Subreddit</label>
    <input type="text" id="node-input-subreddit" placeholder="subreddit name">
  </div>
  <div class="form-row">
    <label for="node-input-subreddit"><i class="icon-tag"></i> Timeout (s)</label>
    <input type="text" id="node-input-timeout" placeholder="optional timeout in seconds">
  </div>
</script>

<script type="text/x-red" data-help-name="stream">
  <p>Stream submissions or comments from a subreddit</p>
</script>
<!-- END Stream -->
 