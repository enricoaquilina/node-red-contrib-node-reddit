<!-- START Config Node -->
<script type="text/x-red" data-template-name="reddit-credentials">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span> Name</span></label>
        <input type="text" id="node-config-input-name">
    </div>
    <hr>
    <div class="form-row">
        <label for="node-config-input-client_id"><i class="fa fa-tag"></i> <span>Client ID</span></label>
        <input type="text" id="node-config-input-client_id">
    </div>
    <div class="form-row">
        <label for="node-config-input-client_secret"><i class="fa fa-key"></i> <span> Client secret</span></label>
        <input type="text" id="node-config-input-client_secret">
    </div>
    <div class="form-row">
        <label for="node-config-input-user_agent"><i class="fa fa-tag"></i> <span> User agent</span></label>
        <input type="text" id="node-config-input-user_agent">
    </div>
    <div class="form-row" id="node-action-auth_type"> 
        <label for="node-config-input-auth_type"><i class="fa fa-wrench"></i> Authentication</label>
        <select type="text" id="node-config-input-auth_type" style="display: inline-block; width: 250px; vertical-align: top;">
            <option value="username_password" outputs="1">Username/password</option>
            <option value="refresh_token" outputs="1">Refresh token</option>
            <option value="access_token" outputs="1">Access token</option>
        </select>
    </div>
    <div class="form-row" id="node-action-username">
        <label for="node-config-input-username"><i class="fa fa-tag"></i> <span> Username</span></label>
            <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row" id="node-action-password">
        <label for="node-config-input-password"><i class="fa fa-key"></i> <span> Password</span></label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row" id="node-action-refresh_token">
        <label for="node-config-input-refresh_token"><i class="fa fa-key"></i> <span> Refresh Token</span></label>
        <input type="text" id="node-config-input-refresh_token">
    </div>
    <div class="form-row" id="node-action-access_token">
        <label for="node-config-input-access_token"><i class="fa fa-key"></i> <span> Access Token</span></label>
        <input type="text" id="node-config-input-access_token">
    </div>
</script>

<script type="text/javascript">
    function oneditprepare() {
        function hideExtraActions(){
            $("#node-action-username").hide();
            $("#node-action-password").hide();
            $("#node-action-refresh_token").hide();
            $("#node-action-access_token").hide();
        }

        function showActions(){
            var auth_type = $("#node-config-input-auth_type option:selected").val();
            if (auth_type == "username_password") {
                $("#node-action-username").show();
                $("#node-action-password").show();
            }
            else if (auth_type == "refresh_token"){
                $("#node-action-refresh_token").show();
            } 
            else if (auth_type == "access_token"){
                $("#node-action-access_token").show();
            } 
        }

        $("#node-config-input-auth_type").change(function() {
            hideExtraActions()
            showActions()
        });

        hideExtraActions()
        showActions()
    }


    RED.nodes.registerType('reddit-credentials',{
      defaults: {
        username: {value:"", required: false},
        user_agent: {value:"", required: true},
        auth_type:  {value:"username_password", required: false},
        name: {value:"", required: false}
        },
      category: 'config',
      credentials: {
        password: {type: "password", required: false},
        client_id: {type: "password", required: true},
        client_secret: {type: "password", required: true},
        refresh_token: {type:"password", required: false},
        access_token: {type:"password", required: false}
      },
      label: function() {
        return this.username || this.name;
      },
      exportable: false,
      oneditprepare: oneditprepare
    });
</script>

<script type="text/x-red" data-help-name="reddit-credentials">
    <p>Authentication for the Reddit API</p>
    <p>To create a Reddit app and obtain its Client ID and Client Secret, log in to your Reddit account and visit <a href="https://ssl.reddit.com/prefs/apps/">this link.</a></p>
    <p>There are 3 ways to provide authentication:</p>
    <ol>
        <li><i>Username/password</i>: For long-term access. Possible for script-type apps only.</li>
        <li><i>Refresh token</i>: For long-term access. Visit <a href="https://not-an-aardvark.github.io/reddit-oauth-helper/">here</a> to generate a token.</li>
        <li><i>Access token</i>: For short-term access. Expires in one hour. Visit <a href="https://not-an-aardvark.github.io/reddit-oauth-helper/">here</a> to generate a token.</li>
    </ol>
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/reddit-archive/reddit/wiki/oauth2">Reddit OAuth2 docs</a> - full description of authtication methods</li>
        <li><a href="https://not-an-aardvark.github.io/snoowrap/snoowrap.html">Snoowrap docs</a> - guidelines for creating Snoowrap objects</li>
    </ul>
</script>
<!-- END Config Node -->
 
<!-- START Stream -->
<script type="text/javascript">
  RED.nodes.registerType('stream', {
    category: 'reddit',
    color: '#a6bbcf',
    defaults: {
      name: {value: ""},
      reddit: {type: "reddit-credentials", required: true},
      kind: {value: "submissions", required: true},
      subreddit: {value: "", required: true},
      timeout: {value: ""}
    },
    inputs: 0,
    outputs: 1,
    icon: "inject.png",
    label: function() {
      if (this.name) {
        return this.name;
      } else if (this.subreddit) {
        return "r/" + this.subreddit;
      } else {
        return "stream";
      }
    }
  });
</script>
  
<script type="text/x-red" data-template-name="stream">
  <div class="form-row">
    <label for="node-input-reddit"><i class="fa fa-key"></i> Credentials</label>
    <input type="text" id="node-input-reddit">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="optional name for this node">
  </div>
  <hr>
  <div class="form-row"> 
    <label for="node-input-kind"><i class="fa fa-wrench"></i> Stream</label>
    <select type="text" id="node-input-kind" style="display: inline-block; width: 250px; vertical-align: top;">
      <option value="submissions" outputs="1">Submissions</option>                            
      <option value="comments" outputs="1">Comments</option>                            
    </select>
  </div>
  <div class="form-row">
    <label for="node-input-subreddit"><i class="icon-tag"></i> Subreddit</label>
    <input type="text" id="node-input-subreddit" placeholder="subreddit name">
  </div>
  <div class="form-row">
    <label for="node-input-subreddit"><i class="icon-tag"></i> Timeout (s)</label>
    <input type="text" id="node-input-timeout" placeholder="optional timeout in seconds">
  </div>
</script>
  
<script type="text/x-red" data-help-name="stream">
  <p>Stream submissions or comments from a subreddit.</p>
    
  <h3>Inputs</h3>
    <dl class="message-properties">
      <dt>credentials <span class="property-type">config node</span></dt>
      <dd> your reddit credentials.</dd>
      <dt>stream <span class="property-type">selection</span></dt>
      <dd> choose comments or submissions.</dd>
      <dt>subreddit <span class="property-type">string</span></dt>
      <dd> the subreddit to stream.</dd>

      <dt class="optional">name <span class="property-type">string</span></dt>
      <dd> the name of this node.</dd>
      <dt class="optional">timeout <span class="property-type">number</span></dt>
      <dd> the length of time to stream in seconds.</dd>
    </dl>

  <h3>Outputs</h3>
    <ol class="node-ports">
      <li>Standard output
        <dl class="message-properties">
          <dt>payload <span class="property-type">object</span></dt>
          <dd> details of the comment or submission.</dd>
        </dl>
      </li>
      <li>Standard error
        <dl class="message-properties">
          <dt>payload <span class="property-type">string</span></dt>
          <dd>the standard error of the command.</dd>
         </dl>
      </li>
    </ol>

  <h3>Details</h3>
    <p>Exclude the "r/" when entering your <code>subreddit</code>. "r/<code>subreddit</code>" will be 
    used for the display name if <code>name</code> is left empty.
    </p>
    <p>The <code>timeout</code> will stop the stream after the desired number of seconds.
    If left blank, the stream will continue until the node is deleted from the flow, an error is thrown,
    or node-red is shutdown.
    </p>

  <h3>References</h3>
    <ul>
      <li><a href='https://www.reddit.com/dev/api/'>Reddit API docs</a> - descriptions of comment and submission listings</li>
      <li><a href='https://github.com/jcostello93/Node-Red'>Node-Reddit on GitHub</a> - the Node-Reddit github repository</li>
    </ul>
</script>
<!-- END Stream -->
